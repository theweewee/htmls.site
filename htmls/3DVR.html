<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Editor 3D A-Frame VR Pro</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    #ui {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.95);
      padding: 12px;
      border-radius: 10px;
      color: #fff;
      width: 280px;
      max-height: 95vh;
      overflow-y: auto;
      font-family: system-ui, sans-serif;
      font-size: 11px;
      z-index: 9999;
      border: 1px solid #333;
    }
    
    #ui::-webkit-scrollbar { width: 5px; }
    #ui::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
    
    h2 { font-size: 14px; margin-bottom: 10px; color: #0ff; text-align: center; }
    h3 { font-size: 11px; margin: 10px 0 6px; color: #f0f; border-top: 1px solid #333; padding-top: 8px; }
    
    label { display: block; font-size: 10px; margin: 5px 0 2px; color: #aaa; }
    input[type="range"] { width: 100%; accent-color: #0ff; }
    input[type="color"] { width: 35px; height: 20px; border: none; border-radius: 3px; cursor: pointer; }
    input[type="checkbox"] { accent-color: #0ff; }
    input[type="text"] { width: 100%; padding: 4px; background: #222; border: 1px solid #444; border-radius: 3px; color: #fff; font-size: 10px; }
    
    select, button {
      width: 100%;
      padding: 6px;
      margin: 2px 0;
      border: 1px solid #444;
      border-radius: 4px;
      background: #222;
      color: #fff;
      font-size: 10px;
      cursor: pointer;
    }
    
    button { background: linear-gradient(135deg, #0ff, #f0f); color: #000; font-weight: bold; }
    button:hover { opacity: 0.85; }
    button.secondary { background: #333; color: #fff; }
    button.danger { background: #a33; color: #fff; }
    button.warning { background: #a93; color: #fff; }
    
    .row { display: flex; gap: 6px; align-items: center; }
    .btn-row { display: flex; gap: 4px; flex-wrap: wrap; }
    .btn-row button { flex: 1; min-width: 60px; }
    
    .section { background: #1a1a1a; padding: 8px; border-radius: 6px; margin: 6px 0; }
    
    #objectList { max-height: 100px; overflow-y: auto; margin-top: 6px; }
    .obj-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 6px;
      background: #222;
      border-radius: 3px;
      margin: 2px 0;
      cursor: pointer;
      border: 1px solid transparent;
    }
    .obj-item:hover { background: #333; }
    .obj-item.selected { border-color: #0ff; background: #1a2a2a; }
    .obj-item.locked { opacity: 0.5; }
    .obj-item button { width: auto; padding: 2px 6px; font-size: 9px; }
    .obj-item .btns { display: flex; gap: 2px; }
    
    .preset-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 3px; }
    .preset-btn { padding: 4px; font-size: 9px; }
    
    .mode-btns { display: flex; gap: 4px; margin-bottom: 8px; }
    .mode-btns button { flex: 1; }
    .mode-btns button.active { background: #0ff; color: #000; }
    
    #toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #0ff;
      color: #000;
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: bold;
      display: none;
      z-index: 10000;
    }
    
    #toolbar {
      position: fixed;
      top: 10px;
      right: 10px;
      display: flex;
      gap: 6px;
      z-index: 9999;
      flex-wrap: wrap;
      max-width: 200px;
      justify-content: flex-end;
    }
    #toolbar button { width: auto; padding: 6px 10px; }
    
    #helpPanel {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.95);
      padding: 20px;
      border-radius: 10px;
      color: #fff;
      z-index: 10001;
      display: none;
      min-width: 300px;
      border: 2px solid #0ff;
    }
    #helpPanel h2 { margin-bottom: 15px; }
    #helpPanel table { width: 100%; }
    #helpPanel td { padding: 4px 8px; font-size: 11px; }
    #helpPanel td:first-child { color: #0ff; font-weight: bold; }
    #helpPanel .close { position: absolute; top: 10px; right: 10px; background: none; border: none; color: #fff; font-size: 20px; cursor: pointer; }
    
    #statusBar {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: rgba(0,0,0,0.8);
      padding: 6px 12px;
      border-radius: 6px;
      color: #0ff;
      font-family: monospace;
      font-size: 11px;
      z-index: 9999;
    }
    
    .tab-btns { display: flex; gap: 2px; margin-bottom: 8px; }
    .tab-btns button { flex: 1; font-size: 9px; padding: 4px; }
    .tab-btns button.active { background: #0ff; color: #000; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
  </style>
</head>
<body>
  <div id="toolbar">
    <button onclick="undo()" class="secondary" title="Ctrl+Z">‚Ü∂ Undo</button>
    <button onclick="redo()" class="secondary" title="Ctrl+Y">‚Ü∑ Redo</button>
    <button onclick="takeScreenshot()" class="secondary">üì∑</button>
    <button onclick="exportScene()" class="secondary">üíæ</button>
    <button onclick="document.getElementById('importFile').click()" class="secondary">üìÇ</button>
    <button onclick="toggleHelp()" class="secondary">‚ùì</button>
    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importScene(event)">
  </div>

  <div id="ui">
    <h2>ü•Ω Editor 3D A-Frame VR Pro</h2>
    
    <!-- Mode buttons -->
    <div class="mode-btns">
      <button id="modeSelect" class="active" onclick="setMode('select')">üéØ Selecionar</button>
      <button id="modeMove" onclick="setMode('move')">‚úã Mover</button>
    </div>
    
    <!-- Tabs -->
    <div class="tab-btns">
      <button class="active" onclick="showTab('objects')">Objetos</button>
      <button onclick="showTab('transform')">Transform</button>
      <button onclick="showTab('material')">Material</button>
      <button onclick="showTab('scene')">Cena</button>
    </div>
    
    <!-- Objects Tab -->
    <div id="tab-objects" class="tab-content active">
      <div class="section">
        <label>Adicionar Objeto:</label>
        <select id="shapeType">
          <option value="sphere">Esfera</option>
          <option value="box">Cubo</option>
          <option value="torus">Torus</option>
          <option value="cone">Cone</option>
          <option value="cylinder">Cilindro</option>
          <option value="dodecahedron">Dodecaedro</option>
          <option value="octahedron">Octaedro</option>
          <option value="tetrahedron">Tetraedro</option>
          <option value="icosahedron">Icosaedro</option>
          <option value="ring">Anel</option>
          <option value="plane">Plano</option>
          <option value="torusKnot">Torus Knot</option>
        </select>
        <div class="btn-row">
          <button onclick="addObject()">+ Adicionar</button>
          <button onclick="duplicateSelected()" class="secondary">‚ßâ Duplicar</button>
        </div>
        
        <label style="margin-top:8px">Texto 3D:</label>
        <div class="row">
          <input type="text" id="text3dInput" placeholder="Digite o texto..." value="Hello">
          <button onclick="addText3D()" style="width:auto;padding:4px 8px">+</button>
        </div>
      </div>
      
      <h3>üì¶ Objetos na Cena</h3>
      <div id="objectList"></div>
      
      <div class="btn-row" style="margin-top:8px">
        <button onclick="lockSelected()" class="warning">üîí Lock</button>
        <button onclick="unlockSelected()" class="secondary">üîì Unlock</button>
        <button onclick="alignToCenter()" class="secondary">‚äï Centro</button>
      </div>
      
      <div class="btn-row">
        <button onclick="deleteSelected()" class="danger">üóëÔ∏è Excluir</button>
        <button onclick="clearScene()" class="danger">üí• Limpar</button>
      </div>
    </div>
    
    <!-- Transform Tab -->
    <div id="tab-transform" class="tab-content">
      <div class="section">
        <div class="row">
          <label><input type="checkbox" id="snapEnabled"> Snap to Grid</label>
          <label>Size: <input type="number" id="snapSize" value="0.5" min="0.1" max="2" step="0.1" style="width:50px"></label>
        </div>
      </div>
      
      <div class="section">
        <label>Escala: <span id="scaleVal">1.0</span></label>
        <input type="range" id="scale" min="0.1" max="5" step="0.1" value="1" oninput="updateTransform()">
        
        <label>Posi√ß√£o X: <span id="posXVal">0</span></label>
        <input type="range" id="posX" min="-10" max="10" step="0.1" value="0" oninput="updateTransform()">
        
        <label>Posi√ß√£o Y: <span id="posYVal">1</span></label>
        <input type="range" id="posY" min="0" max="10" step="0.1" value="1" oninput="updateTransform()">
        
        <label>Posi√ß√£o Z: <span id="posZVal">-3</span></label>
        <input type="range" id="posZ" min="-15" max="5" step="0.1" value="-3" oninput="updateTransform()">
        
        <label>Rota√ß√£o X: <span id="rotXVal">0</span>¬∞</label>
        <input type="range" id="rotX" min="0" max="360" step="1" value="0" oninput="updateTransform()">
        
        <label>Rota√ß√£o Y: <span id="rotYVal">0</span>¬∞</label>
        <input type="range" id="rotY" min="0" max="360" step="1" value="0" oninput="updateTransform()">
        
        <label>Rota√ß√£o Z: <span id="rotZVal">0</span>¬∞</label>
        <input type="range" id="rotZ" min="0" max="360" step="1" value="0" oninput="updateTransform()">
      </div>
      
      <h3>üé¨ Anima√ß√£o</h3>
      <div class="section">
        <div class="row">
          <label><input type="checkbox" id="animEnabled" onchange="updateAnimation()"> Rota√ß√£o Auto</label>
        </div>
        <label>Velocidade: <span id="animSpeedVal">2000</span>ms</label>
        <input type="range" id="animSpeed" min="500" max="10000" step="100" value="2000" oninput="updateAnimation()">
        
        <div class="row">
          <label><input type="checkbox" id="animX" onchange="updateAnimation()"> X</label>
          <label><input type="checkbox" id="animY" checked onchange="updateAnimation()"> Y</label>
          <label><input type="checkbox" id="animZ" onchange="updateAnimation()"> Z</label>
        </div>
      </div>
    </div>
    
    <!-- Material Tab -->
    <div id="tab-material" class="tab-content">
      <h3>üé® Presets</h3>
      <div class="preset-grid">
        <button class="preset-btn secondary" onclick="applyPreset('glass')">ü´ß Vidro</button>
        <button class="preset-btn secondary" onclick="applyPreset('metal')">‚öôÔ∏è Metal</button>
        <button class="preset-btn secondary" onclick="applyPreset('plastic')">üéØ Pl√°stico</button>
        <button class="preset-btn secondary" onclick="applyPreset('gold')">ü•á Ouro</button>
        <button class="preset-btn secondary" onclick="applyPreset('chrome')">ü™û Chrome</button>
        <button class="preset-btn secondary" onclick="applyPreset('neon')">üí° Neon</button>
        <button class="preset-btn secondary" onclick="applyPreset('glow')">‚ú® Glow</button>
        <button class="preset-btn secondary" onclick="applyPreset('rubber')">üèÄ Rubber</button>
        <button class="preset-btn secondary" onclick="applyPreset('ceramic')">üè∫ Ceramic</button>
      </div>
      
      <h3>üé® Propriedades</h3>
      <div class="section">
        <div class="row">
          <label>Cor:</label>
          <input type="color" id="color" value="#4CC3D9" onchange="updateMaterial()">
          <label>Emissivo:</label>
          <input type="color" id="emissive" value="#000000" onchange="updateMaterial()">
        </div>
        
        <label>Metalness: <span id="metalnessVal">0.00</span></label>
        <input type="range" id="metalness" min="0" max="1" step="0.01" value="0" oninput="updateMaterial()">
        
        <label>Roughness: <span id="roughnessVal">0.50</span></label>
        <input type="range" id="roughness" min="0" max="1" step="0.01" value="0.5" oninput="updateMaterial()">
        
        <label>Opacidade: <span id="opacityVal">1.00</span></label>
        <input type="range" id="opacity" min="0" max="1" step="0.01" value="1" oninput="updateMaterial()">
        
        <label>Emissive Int: <span id="emissiveIntVal">0.00</span></label>
        <input type="range" id="emissiveInt" min="0" max="3" step="0.1" value="0" oninput="updateMaterial()">
        
        <div class="row">
          <label><input type="checkbox" id="wireframe" onchange="updateMaterial()"> Wireframe</label>
          <label><input type="checkbox" id="transparent" onchange="updateMaterial()"> Transparente</label>
        </div>
        <div class="row">
          <label><input type="checkbox" id="doubleSide" onchange="updateMaterial()"> Double Side</label>
        </div>
      </div>
    </div>
    
    <!-- Scene Tab -->
    <div id="tab-scene" class="tab-content">
      <h3>üåç Ambiente</h3>
      <div class="section">
        <div class="row">
          <label>C√©u:</label>
          <input type="color" id="skyColor" value="#1a1a2e" onchange="updateSky()">
          <label>Ch√£o:</label>
          <input type="color" id="groundColor" value="#222222" onchange="updateGround()">
        </div>
        
        <div class="row">
          <label>Luz Amb:</label>
          <input type="color" id="ambientColor" value="#444444" onchange="updateLights()">
          <label>Luz Dir:</label>
          <input type="color" id="directionalColor" value="#ffffff" onchange="updateLights()">
        </div>
        
        <label>Intensidade Luz: <span id="lightIntVal">1.0</span></label>
        <input type="range" id="lightInt" min="0" max="3" step="0.1" value="1" oninput="updateLights()">
        
        <div class="row">
          <label><input type="checkbox" id="gridEnabled" checked onchange="updateGrid()"> Grid</label>
          <label><input type="checkbox" id="starsEnabled" checked onchange="updateStars()"> Estrelas</label>
          <label><input type="checkbox" id="shadowsEnabled" checked onchange="updateShadows()"> Sombras</label>
        </div>
      </div>
      
      <h3>üå´Ô∏è Fog</h3>
      <div class="section">
        <div class="row">
          <label><input type="checkbox" id="fogEnabled" onchange="updateFog()"> Ativar Fog</label>
          <input type="color" id="fogColor" value="#1a1a2e" onchange="updateFog()">
        </div>
        <label>Densidade: <span id="fogDensityVal">0.05</span></label>
        <input type="range" id="fogDensity" min="0.01" max="0.2" step="0.01" value="0.05" oninput="updateFog()">
      </div>
      
      <h3>üé• C√¢mera</h3>
      <div class="section">
        <label>FOV: <span id="fovVal">80</span>¬∞</label>
        <input type="range" id="fov" min="30" max="120" step="1" value="80" oninput="updateCamera()">
        
        <div class="btn-row">
          <button onclick="resetCamera()" class="secondary">üè† Reset C√¢mera</button>
        </div>
      </div>
    </div>
  </div>
  
  <div id="statusBar">
    Mode: <span id="currentMode">Select</span> | Objects: <span id="objectCount">0</span> | <span id="selectedInfo">Nenhum selecionado</span>
  </div>
  
  <div id="helpPanel">
    <button class="close" onclick="toggleHelp()">√ó</button>
    <h2>‚å®Ô∏è Atalhos de Teclado</h2>
    <table>
      <tr><td>Delete</td><td>Excluir objeto selecionado</td></tr>
      <tr><td>Ctrl+D</td><td>Duplicar objeto</td></tr>
      <tr><td>Ctrl+Z</td><td>Desfazer</td></tr>
      <tr><td>Ctrl+Y</td><td>Refazer</td></tr>
      <tr><td>G</td><td>Toggle Grid</td></tr>
      <tr><td>L</td><td>Lock/Unlock objeto</td></tr>
      <tr><td>C</td><td>Centralizar objeto</td></tr>
      <tr><td>M</td><td>Alternar modo Move/Select</td></tr>
      <tr><td>H</td><td>Mostrar/Ocultar ajuda</td></tr>
      <tr><td>1-4</td><td>Trocar abas</td></tr>
    </table>
  </div>
  
  <div id="toast"></div>

  <a-scene id="scene" vr-mode-ui="enabled: true" shadow="type: pcfsoft">
    <!-- Camera -->
    <a-entity id="rig" position="0 1.6 4">
      <a-camera id="camera" look-controls wasd-controls fov="80">
        <a-cursor color="#0ff" fuse="false" raycaster="objects: .clickable"></a-cursor>
      </a-camera>
    </a-entity>
    
    <!-- Lights -->
    <a-light id="ambientLight" type="ambient" color="#444" intensity="0.5"></a-light>
    <a-light id="directionalLight" type="directional" color="#fff" intensity="1" position="2 4 2" castShadow="true" shadow="mapSize: 2048 2048"></a-light>
    <a-light type="point" color="#0ff" intensity="0.5" position="3 3 3"></a-light>
    <a-light type="point" color="#f0f" intensity="0.5" position="-3 3 -3"></a-light>
    
    <!-- Sky -->
    <a-sky id="sky" color="#1a1a2e"></a-sky>
    
    <!-- Stars -->
    <a-entity id="stars"></a-entity>
    
    <!-- Ground -->
    <a-plane id="ground" rotation="-90 0 0" width="50" height="50" color="#222" material="side: double" shadow="receive: true"></a-plane>
    
    <!-- Grid -->
    <a-entity id="grid" position="0 0.01 0"></a-entity>
    
    <!-- Objects Container -->
    <a-entity id="objectsContainer"></a-entity>
  </a-scene>

  <script>
    // State
    let objects = [];
    let selectedObject = null;
    let objectId = 0;
    let currentMode = 'select';
    let isDragging = false;
    let dragPlane = null;
    let undoStack = [];
    let redoStack = [];
    const MAX_UNDO = 50;
    
    const container = document.getElementById('objectsContainer');
    const scene = document.getElementById('scene');
    
    // Tabs
    function showTab(name) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-btns button').forEach(b => b.classList.remove('active'));
      document.getElementById(`tab-${name}`).classList.add('active');
      event.target.classList.add('active');
    }
    
    // Mode
    function setMode(mode) {
      currentMode = mode;
      document.getElementById('modeSelect').classList.toggle('active', mode === 'select');
      document.getElementById('modeMove').classList.toggle('active', mode === 'move');
      document.getElementById('currentMode').textContent = mode === 'select' ? 'Select' : 'Move';
      showToast(`Modo: ${mode === 'select' ? 'Selecionar' : 'Mover'}`);
    }
    
    // Create grid
    function createGrid() {
      const grid = document.getElementById('grid');
      grid.innerHTML = '';
      
      for (let i = -10; i <= 10; i++) {
        const lineX = document.createElement('a-entity');
        lineX.setAttribute('line', `start: -10 0 ${i}; end: 10 0 ${i}; color: #444`);
        grid.appendChild(lineX);
        
        const lineZ = document.createElement('a-entity');
        lineZ.setAttribute('line', `start: ${i} 0 -10; end: ${i} 0 10; color: #444`);
        grid.appendChild(lineZ);
      }
    }
    
    // Create stars
    function createStars() {
      const stars = document.getElementById('stars');
      stars.innerHTML = '';
      
      for (let i = 0; i < 200; i++) {
        const star = document.createElement('a-sphere');
        const x = (Math.random() - 0.5) * 100;
        const y = Math.random() * 50 + 10;
        const z = (Math.random() - 0.5) * 100;
        star.setAttribute('position', `${x} ${y} ${z}`);
        star.setAttribute('radius', Math.random() * 0.1 + 0.02);
        star.setAttribute('color', '#fff');
        star.setAttribute('material', 'shader: flat');
        stars.appendChild(star);
      }
    }
    
    // Save state for undo
    function saveState() {
      const state = objects.map(obj => ({
        id: obj.userData.id,
        type: obj.userData.type,
        name: obj.userData.name,
        locked: obj.userData.locked,
        position: {...obj.getAttribute('position')},
        rotation: {...(obj.getAttribute('rotation') || {x:0,y:0,z:0})},
        scale: {...(obj.getAttribute('scale') || {x:1,y:1,z:1})},
        material: {...obj.getAttribute('material')},
        animation: {...obj.userData.animation}
      }));
      
      undoStack.push(JSON.stringify(state));
      if (undoStack.length > MAX_UNDO) undoStack.shift();
      redoStack = [];
    }
    
    // Undo
    function undo() {
      if (undoStack.length < 2) { showToast('Nada para desfazer'); return; }
      
      redoStack.push(undoStack.pop());
      const state = JSON.parse(undoStack[undoStack.length - 1]);
      restoreState(state);
      showToast('Desfeito!');
    }
    
    // Redo
    function redo() {
      if (redoStack.length === 0) { showToast('Nada para refazer'); return; }
      
      const state = JSON.parse(redoStack.pop());
      undoStack.push(JSON.stringify(state));
      restoreState(state);
      showToast('Refeito!');
    }
    
    // Restore state
    function restoreState(state) {
      // Remove current objects
      objects.forEach(obj => obj.parentNode.removeChild(obj));
      objects = [];
      
      // Recreate objects
      state.forEach(d => {
        const el = createObjectElement(d.type);
        el.userData.id = d.id;
        el.userData.name = d.name;
        el.userData.locked = d.locked;
        el.userData.animation = d.animation;
        
        el.setAttribute('position', d.position);
        el.setAttribute('rotation', d.rotation);
        el.setAttribute('scale', d.scale);
        el.setAttribute('material', d.material);
        
        container.appendChild(el);
        objects.push(el);
      });
      
      selectedObject = objects[0] || null;
      selectObject(selectedObject);
      updateObjectList();
    }
    
    // Create object element
    function createObjectElement(type) {
      const el = document.createElement('a-entity');
      const id = `obj_${objectId++}`;
      el.setAttribute('id', id);
      el.setAttribute('class', 'clickable');
      
      let geomAttr = `primitive: ${type}`;
      if (type === 'sphere') geomAttr += '; radius: 0.5; segmentsWidth: 32; segmentsHeight: 32';
      else if (type === 'box') geomAttr += '; width: 1; height: 1; depth: 1';
      else if (type === 'torus') geomAttr += '; radius: 0.5; radiusTubular: 0.15; segmentsRadial: 32; segmentsTubular: 48';
      else if (type === 'cone') geomAttr += '; radiusBottom: 0.5; radiusTop: 0; height: 1';
      else if (type === 'cylinder') geomAttr += '; radius: 0.4; height: 1';
      else if (type === 'plane') geomAttr += '; width: 2; height: 2';
      else if (type === 'ring') geomAttr += '; radiusInner: 0.3; radiusOuter: 0.6';
      else if (type === 'dodecahedron') geomAttr += '; radius: 0.5';
      else if (type === 'octahedron') geomAttr += '; radius: 0.5';
      else if (type === 'tetrahedron') geomAttr += '; radius: 0.5';
      else if (type === 'icosahedron') geomAttr += '; radius: 0.5';
      else if (type === 'torusKnot') geomAttr += '; radius: 0.4; radiusTubular: 0.1; p: 2; q: 3';
      
      el.setAttribute('geometry', geomAttr);
      el.setAttribute('material', 'color: #4CC3D9; metalness: 0; roughness: 0.5; shader: standard');
      el.setAttribute('shadow', 'cast: true; receive: true');
      
      el.userData = {
        id: id,
        type: type,
        name: `${type}_${objectId}`,
        locked: false,
        animation: { enabled: false, speed: 2000, x: false, y: true, z: false }
      };
      
      el.addEventListener('click', (e) => {
        e.stopPropagation();
        if (currentMode === 'select') {
          selectObject(el);
        } else if (currentMode === 'move' && !el.userData.locked) {
          selectObject(el);
          startDrag(e);
        }
      });
      
      return el;
    }
    
    // Add object
    function addObject(type = null) {
      saveState();
      type = type || document.getElementById('shapeType').value;
      
      const el = createObjectElement(type);
      el.setAttribute('position', '0 1 -3');
      
      container.appendChild(el);
      objects.push(el);
      selectObject(el);
      updateObjectList();
      updateStatusBar();
      showToast(`${type} adicionado!`);
      
      return el;
    }
    
    // Add 3D Text
    function addText3D() {
      saveState();
      const text = document.getElementById('text3dInput').value || 'Hello';
      
      const el = document.createElement('a-entity');
      const id = `obj_${objectId++}`;
      el.setAttribute('id', id);
      el.setAttribute('class', 'clickable');
      el.setAttribute('text', `value: ${text}; color: #fff; align: center; width: 4; font: roboto`);
      el.setAttribute('position', '0 1.5 -3');
      
      el.userData = {
        id: id,
        type: 'text',
        name: `text_${objectId}`,
        locked: false,
        animation: { enabled: false, speed: 2000, x: false, y: true, z: false }
      };
      
      el.addEventListener('click', (e) => {
        e.stopPropagation();
        selectObject(el);
      });
      
      container.appendChild(el);
      objects.push(el);
      selectObject(el);
      updateObjectList();
      updateStatusBar();
      showToast('Texto adicionado!');
    }
    
    // Drag functionality
    function startDrag(e) {
      if (!selectedObject || selectedObject.userData.locked) return;
      isDragging = true;
      document.body.style.cursor = 'grabbing';
    }
    
    // Mouse move for dragging
    document.addEventListener('mousemove', (e) => {
      if (!isDragging || !selectedObject) return;
      
      const camera = document.getElementById('camera');
      const camPos = camera.object3D.getWorldPosition(new THREE.Vector3());
      
      // Simple drag - move in XZ plane based on mouse
      const rect = scene.canvas.getBoundingClientRect();
      const x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
      const y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
      
      const pos = selectedObject.getAttribute('position');
      let newX = pos.x + x * 0.1;
      let newZ = pos.z - y * 0.1;
      
      // Snap to grid
      if (document.getElementById('snapEnabled').checked) {
        const snapSize = parseFloat(document.getElementById('snapSize').value);
        newX = Math.round(newX / snapSize) * snapSize;
        newZ = Math.round(newZ / snapSize) * snapSize;
      }
      
      selectedObject.setAttribute('position', `${newX} ${pos.y} ${newZ}`);
      updateTransformUI();
    });
    
    document.addEventListener('mouseup', () => {
      if (isDragging) {
        isDragging = false;
        document.body.style.cursor = 'default';
        saveState();
      }
    });
    
    // Select object
    function selectObject(el) {
      if (selectedObject) {
        selectedObject.removeAttribute('animation__pulse');
      }
      
      selectedObject = el;
      if (!el) { 
        updateObjectList(); 
        updateStatusBar();
        return; 
      }
      
      // Pulse animation for selection feedback
      el.setAttribute('animation__pulse', {
        property: 'scale',
        from: el.getAttribute('scale') || '1 1 1',
        to: `${(el.getAttribute('scale')?.x || 1) * 1.05} ${(el.getAttribute('scale')?.y || 1) * 1.05} ${(el.getAttribute('scale')?.z || 1) * 1.05}`,
        dur: 200,
        dir: 'alternate',
        loop: 2
      });
      
      setTimeout(() => el.removeAttribute('animation__pulse'), 500);
      
      updateTransformUI();
      updateMaterialUI();
      updateAnimationUI();
      updateObjectList();
      updateStatusBar();
    }
    
    function updateTransformUI() {
      if (!selectedObject) return;
      
      const pos = selectedObject.getAttribute('position');
      const rot = selectedObject.getAttribute('rotation') || {x:0,y:0,z:0};
      const scale = selectedObject.getAttribute('scale') || {x:1,y:1,z:1};
      
      document.getElementById('scale').value = scale.x;
      document.getElementById('scaleVal').textContent = scale.x.toFixed(1);
      document.getElementById('posX').value = pos.x;
      document.getElementById('posXVal').textContent = pos.x.toFixed(1);
      document.getElementById('posY').value = pos.y;
      document.getElementById('posYVal').textContent = pos.y.toFixed(1);
      document.getElementById('posZ').value = pos.z;
      document.getElementById('posZVal').textContent = pos.z.toFixed(1);
      document.getElementById('rotX').value = rot.x || 0;
      document.getElementById('rotXVal').textContent = Math.round(rot.x || 0);
      document.getElementById('rotY').value = rot.y || 0;
      document.getElementById('rotYVal').textContent = Math.round(rot.y || 0);
      document.getElementById('rotZ').value = rot.z || 0;
      document.getElementById('rotZVal').textContent = Math.round(rot.z || 0);
    }
    
    function updateMaterialUI() {
      if (!selectedObject) return;
      
      const mat = selectedObject.getAttribute('material') || {};
      
      document.getElementById('color').value = mat.color || '#4CC3D9';
      document.getElementById('emissive').value = mat.emissive || '#000000';
      document.getElementById('metalness').value = mat.metalness || 0;
      document.getElementById('metalnessVal').textContent = (mat.metalness || 0).toFixed(2);
      document.getElementById('roughness').value = mat.roughness !== undefined ? mat.roughness : 0.5;
      document.getElementById('roughnessVal').textContent = (mat.roughness !== undefined ? mat.roughness : 0.5).toFixed(2);
      document.getElementById('opacity').value = mat.opacity !== undefined ? mat.opacity : 1;
      document.getElementById('opacityVal').textContent = (mat.opacity !== undefined ? mat.opacity : 1).toFixed(2);
      document.getElementById('emissiveInt').value = mat.emissiveIntensity || 0;
      document.getElementById('emissiveIntVal').textContent = (mat.emissiveIntensity || 0).toFixed(2);
      document.getElementById('wireframe').checked = mat.wireframe || false;
      document.getElementById('transparent').checked = mat.transparent || false;
      document.getElementById('doubleSide').checked = mat.side === 'double';
    }
    
    function updateAnimationUI() {
      if (!selectedObject) return;
      
      const anim = selectedObject.userData?.animation || { enabled: false, speed: 2000, x: false, y: true, z: false };
      document.getElementById('animEnabled').checked = anim.enabled;
      document.getElementById('animSpeed').value = anim.speed;
      document.getElementById('animSpeedVal').textContent = anim.speed;
      document.getElementById('animX').checked = anim.x;
      document.getElementById('animY').checked = anim.y;
      document.getElementById('animZ').checked = anim.z;
    }
    
    // Update transform
    function updateTransform() {
      if (!selectedObject || selectedObject.userData.locked) return;
      
      const s = parseFloat(document.getElementById('scale').value);
      let px = parseFloat(document.getElementById('posX').value);
      let py = parseFloat(document.getElementById('posY').value);
      let pz = parseFloat(document.getElementById('posZ').value);
      const rx = parseFloat(document.getElementById('rotX').value);
      const ry = parseFloat(document.getElementById('rotY').value);
      const rz = parseFloat(document.getElementById('rotZ').value);
      
      // Snap
      if (document.getElementById('snapEnabled').checked) {
        const snapSize = parseFloat(document.getElementById('snapSize').value);
        px = Math.round(px / snapSize) * snapSize;
        py = Math.round(py / snapSize) * snapSize;
        pz = Math.round(pz / snapSize) * snapSize;
      }
      
      document.getElementById('scaleVal').textContent = s.toFixed(1);
      document.getElementById('posXVal').textContent = px.toFixed(1);
      document.getElementById('posYVal').textContent = py.toFixed(1);
      document.getElementById('posZVal').textContent = pz.toFixed(1);
      document.getElementById('rotXVal').textContent = Math.round(rx);
      document.getElementById('rotYVal').textContent = Math.round(ry);
      document.getElementById('rotZVal').textContent = Math.round(rz);
      
      selectedObject.setAttribute('scale', `${s} ${s} ${s}`);
      selectedObject.setAttribute('position', `${px} ${py} ${pz}`);
      selectedObject.setAttribute('rotation', `${rx} ${ry} ${rz}`);
    }
    
    // Update material
    function updateMaterial() {
      if (!selectedObject) return;
      
      const color = document.getElementById('color').value;
      const emissive = document.getElementById('emissive').value;
      const metalness = parseFloat(document.getElementById('metalness').value);
      const roughness = parseFloat(document.getElementById('roughness').value);
      const opacity = parseFloat(document.getElementById('opacity').value);
      const emissiveInt = parseFloat(document.getElementById('emissiveInt').value);
      const wireframe = document.getElementById('wireframe').checked;
      const transparent = document.getElementById('transparent').checked;
      const doubleSide = document.getElementById('doubleSide').checked;
      
      document.getElementById('metalnessVal').textContent = metalness.toFixed(2);
      document.getElementById('roughnessVal').textContent = roughness.toFixed(2);
      document.getElementById('opacityVal').textContent = opacity.toFixed(2);
      document.getElementById('emissiveIntVal').textContent = emissiveInt.toFixed(2);
      
      selectedObject.setAttribute('material', {
        color: color,
        emissive: emissive,
        emissiveIntensity: emissiveInt,
        metalness: metalness,
        roughness: roughness,
        opacity: opacity,
        transparent: transparent || opacity < 1,
        wireframe: wireframe,
        side: doubleSide ? 'double' : 'front',
        shader: 'standard'
      });
    }
    
    // Update animation
    function updateAnimation() {
      if (!selectedObject) return;
      
      const enabled = document.getElementById('animEnabled').checked;
      const speed = parseInt(document.getElementById('animSpeed').value);
      const x = document.getElementById('animX').checked;
      const y = document.getElementById('animY').checked;
      const z = document.getElementById('animZ').checked;
      
      document.getElementById('animSpeedVal').textContent = speed;
      
      selectedObject.userData.animation = { enabled, speed, x, y, z };
      
      selectedObject.removeAttribute('animation__rotx');
      selectedObject.removeAttribute('animation__roty');
      selectedObject.removeAttribute('animation__rotz');
      
      if (enabled) {
        const rot = selectedObject.getAttribute('rotation') || {x:0,y:0,z:0};
        
        if (x) {
          selectedObject.setAttribute('animation__rotx', {
            property: 'rotation.x',
            from: rot.x,
            to: rot.x + 360,
            dur: speed,
            loop: true,
            easing: 'linear'
          });
        }
        if (y) {
          selectedObject.setAttribute('animation__roty', {
            property: 'rotation.y',
            from: rot.y,
            to: rot.y + 360,
            dur: speed,
            loop: true,
            easing: 'linear'
          });
        }
        if (z) {
          selectedObject.setAttribute('animation__rotz', {
            property: 'rotation.z',
            from: rot.z,
            to: rot.z + 360,
            dur: speed,
            loop: true,
            easing: 'linear'
          });
        }
      }
    }
    
    // Presets
    const presets = {
      glass: { color: '#ffffff', metalness: 0, roughness: 0, opacity: 0.4, transparent: true, emissive: '#000000', emissiveInt: 0 },
      metal: { color: '#888888', metalness: 1, roughness: 0.2, opacity: 1, transparent: false, emissive: '#000000', emissiveInt: 0 },
      plastic: { color: '#ff4444', metalness: 0, roughness: 0.4, opacity: 1, transparent: false, emissive: '#000000', emissiveInt: 0 },
      gold: { color: '#ffd700', metalness: 1, roughness: 0.1, opacity: 1, transparent: false, emissive: '#000000', emissiveInt: 0 },
      chrome: { color: '#cccccc', metalness: 1, roughness: 0.05, opacity: 1, transparent: false, emissive: '#000000', emissiveInt: 0 },
      neon: { color: '#00ff88', metalness: 0, roughness: 0.5, opacity: 0.9, transparent: true, emissive: '#00ff88', emissiveInt: 2 },
      glow: { color: '#ff00ff', metalness: 0, roughness: 0.3, opacity: 0.8, transparent: true, emissive: '#ff00ff', emissiveInt: 1.5 },
      rubber: { color: '#333333', metalness: 0, roughness: 0.9, opacity: 1, transparent: false, emissive: '#000000', emissiveInt: 0 },
      ceramic: { color: '#f5f5f5', metalness: 0.1, roughness: 0.3, opacity: 1, transparent: false, emissive: '#000000', emissiveInt: 0 }
    };
    
    function applyPreset(name) {
      if (!selectedObject) { showToast('Selecione um objeto'); return; }
      saveState();
      const p = presets[name];
      
      document.getElementById('color').value = p.color;
      document.getElementById('emissive').value = p.emissive;
      document.getElementById('metalness').value = p.metalness;
      document.getElementById('roughness').value = p.roughness;
      document.getElementById('opacity').value = p.opacity;
      document.getElementById('emissiveInt').value = p.emissiveInt;
      document.getElementById('transparent').checked = p.transparent;
      
      updateMaterial();
      showToast(`Preset "${name}"!`);
    }
    
    // Lock/Unlock
    function lockSelected() {
      if (!selectedObject) return;
      saveState();
      selectedObject.userData.locked = true;
      updateObjectList();
      showToast('Objeto travado!');
    }
    
    function unlockSelected() {
      if (!selectedObject) return;
      saveState();
      selectedObject.userData.locked = false;
      updateObjectList();
      showToast('Objeto destravado!');
    }
    
    // Align to center
    function alignToCenter() {
      if (!selectedObject || selectedObject.userData.locked) return;
      saveState();
      const pos = selectedObject.getAttribute('position');
      selectedObject.setAttribute('position', `0 ${pos.y} 0`);
      updateTransformUI();
      showToast('Centralizado!');
    }
    
    // Environment
    function updateSky() {
      document.getElementById('sky').setAttribute('color', document.getElementById('skyColor').value);
    }
    
    function updateGround() {
      document.getElementById('ground').setAttribute('color', document.getElementById('groundColor').value);
    }
    
    function updateLights() {
      const ambColor = document.getElementById('ambientColor').value;
      const dirColor = document.getElementById('directionalColor').value;
      const intensity = parseFloat(document.getElementById('lightInt').value);
      
      document.getElementById('lightIntVal').textContent = intensity.toFixed(1);
      
      document.getElementById('ambientLight').setAttribute('color', ambColor);
      document.getElementById('directionalLight').setAttribute('color', dirColor);
      document.getElementById('directionalLight').setAttribute('intensity', intensity);
    }
    
    function updateGrid() {
      document.getElementById('grid').setAttribute('visible', document.getElementById('gridEnabled').checked);
    }
    
    function updateStars() {
      document.getElementById('stars').setAttribute('visible', document.getElementById('starsEnabled').checked);
    }
    
    function updateShadows() {
      const enabled = document.getElementById('shadowsEnabled').checked;
      document.getElementById('directionalLight').setAttribute('light', `castShadow: ${enabled}`);
    }
    
    function updateFog() {
      const enabled = document.getElementById('fogEnabled').checked;
      const color = document.getElementById('fogColor').value;
      const density = parseFloat(document.getElementById('fogDensity').value);
      
      document.getElementById('fogDensityVal').textContent = density.toFixed(2);
      
      if (enabled) {
        scene.setAttribute('fog', `type: exponential; color: ${color}; density: ${density}`);
      } else {
        scene.removeAttribute('fog');
      }
    }
    
    function updateCamera() {
      const fov = parseInt(document.getElementById('fov').value);
      document.getElementById('fovVal').textContent = fov;
      document.getElementById('camera').setAttribute('fov', fov);
    }
    
    function resetCamera() {
      document.getElementById('rig').setAttribute('position', '0 1.6 4');
      document.getElementById('camera').setAttribute('rotation', '0 0 0');
      showToast('C√¢mera resetada!');
    }
    
    // Object list
    function updateObjectList() {
      const list = document.getElementById('objectList');
      list.innerHTML = objects.map(obj => `
        <div class="obj-item ${obj === selectedObject ? 'selected' : ''} ${obj.userData.locked ? 'locked' : ''}" data-id="${obj.userData.id}">
          <span>${obj.userData.locked ? 'üîí ' : ''}${obj.userData.name}</span>
          <div class="btns">
            <button onclick="event.stopPropagation(); toggleLock('${obj.userData.id}')" class="warning">${obj.userData.locked ? 'üîì' : 'üîí'}</button>
            <button onclick="event.stopPropagation(); deleteObject('${obj.userData.id}')" class="danger">‚úï</button>
          </div>
        </div>
      `).join('');
      
      list.querySelectorAll('.obj-item').forEach(el => {
        el.addEventListener('click', () => {
          const obj = objects.find(o => o.userData.id === el.dataset.id);
          selectObject(obj);
        });
      });
    }
    
    function toggleLock(id) {
      const obj = objects.find(o => o.userData.id === id);
      if (!obj) return;
      saveState();
      obj.userData.locked = !obj.userData.locked;
      updateObjectList();
      showToast(obj.userData.locked ? 'Travado!' : 'Destravado!');
    }
    
    // Delete
    function deleteObject(id) {
      const obj = objects.find(o => o.userData.id === id);
      if (!obj) return;
      
      saveState();
      obj.parentNode.removeChild(obj);
      objects = objects.filter(o => o !== obj);
      
      if (selectedObject === obj) {
        selectedObject = objects[0] || null;
        selectObject(selectedObject);
      }
      updateObjectList();
      updateStatusBar();
      showToast('Exclu√≠do!');
    }
    
    function deleteSelected() {
      if (selectedObject && !selectedObject.userData.locked) {
        deleteObject(selectedObject.userData.id);
      }
    }
    
    // Duplicate
    function duplicateSelected() {
      if (!selectedObject) return;
      saveState();
      
      const type = selectedObject.userData.type;
      let newObj;
      
      if (type === 'text') {
        const text = selectedObject.getAttribute('text').value;
        document.getElementById('text3dInput').value = text;
        addText3D();
        return;
      }
      
      newObj = addObject(type);
      const pos = selectedObject.getAttribute('position');
      const rot = selectedObject.getAttribute('rotation');
      const scale = selectedObject.getAttribute('scale');
      const mat = selectedObject.getAttribute('material');
      
      newObj.setAttribute('position', `${pos.x + 0.5} ${pos.y} ${pos.z + 0.5}`);
      if (rot) newObj.setAttribute('rotation', rot);
      if (scale) newObj.setAttribute('scale', scale);
      newObj.setAttribute('material', mat);
      
      selectObject(newObj);
      showToast('Duplicado!');
    }
    
    // Clear
    function clearScene() {
      if (!confirm('Limpar toda a cena?')) return;
      saveState();
      objects.forEach(obj => obj.parentNode.removeChild(obj));
      objects = [];
      selectedObject = null;
      updateObjectList();
      updateStatusBar();
      showToast('Cena limpa!');
    }
    
    // Screenshot
    function takeScreenshot() {
      const canvas = scene.canvas;
      const link = document.createElement('a');
      link.download = `screenshot_${Date.now()}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
      showToast('Screenshot salvo!');
    }
    
    // Export/Import
    function exportScene() {
      const data = {
        version: '2.0',
        environment: {
          skyColor: document.getElementById('skyColor').value,
          groundColor: document.getElementById('groundColor').value,
          ambientColor: document.getElementById('ambientColor').value,
          directionalColor: document.getElementById('directionalColor').value,
          lightIntensity: parseFloat(document.getElementById('lightInt').value),
          fogEnabled: document.getElementById('fogEnabled').checked,
          fogColor: document.getElementById('fogColor').value,
          fogDensity: parseFloat(document.getElementById('fogDensity').value)
        },
        objects: objects.map(obj => ({
          type: obj.userData.type,
          name: obj.userData.name,
          locked: obj.userData.locked,
          position: obj.getAttribute('position'),
          rotation: obj.getAttribute('rotation'),
          scale: obj.getAttribute('scale'),
          material: obj.getAttribute('material'),
          animation: obj.userData.animation,
          text: obj.userData.type === 'text' ? obj.getAttribute('text')?.value : null
        }))
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `cena_aframe_${Date.now()}.json`;
      a.click();
      showToast('Cena exportada!');
    }
    
    function importScene(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (ev) => {
        try {
          const data = JSON.parse(ev.target.result);
          
          // Clear current
          objects.forEach(obj => obj.parentNode.removeChild(obj));
          objects = [];
          
          // Restore environment
          if (data.environment) {
            document.getElementById('skyColor').value = data.environment.skyColor || '#1a1a2e';
            document.getElementById('groundColor').value = data.environment.groundColor || '#222222';
            document.getElementById('ambientColor').value = data.environment.ambientColor || '#444444';
            document.getElementById('directionalColor').value = data.environment.directionalColor || '#ffffff';
            document.getElementById('lightInt').value = data.environment.lightIntensity || 1;
            document.getElementById('fogEnabled').checked = data.environment.fogEnabled || false;
            document.getElementById('fogColor').value = data.environment.fogColor || '#1a1a2e';
            document.getElementById('fogDensity').value = data.environment.fogDensity || 0.05;
            
            updateSky();
            updateGround();
            updateLights();
            updateFog();
          }
          
          // Restore objects
          data.objects.forEach(d => {
            let obj;
            if (d.type === 'text') {
              document.getElementById('text3dInput').value = d.text || 'Hello';
              addText3D();
              obj = objects[objects.length - 1];
            } else {
              obj = addObject(d.type);
            }
            
            obj.userData.name = d.name;
            obj.userData.locked = d.locked || false;
            obj.setAttribute('position', d.position);
            if (d.rotation) obj.setAttribute('rotation', d.rotation);
            if (d.scale) obj.setAttribute('scale', d.scale);
            if (d.material) obj.setAttribute('material', d.material);
            obj.userData.animation = d.animation || { enabled: false, speed: 2000, x: false, y: true, z: false };
          });
          
          selectedObject = objects[0] || null;
          selectObject(selectedObject);
          saveState();
          showToast('Cena importada!');
        } catch (err) {
          console.error(err);
          showToast('Erro ao importar!');
        }
      };
      reader.readAsText(file);
      e.target.value = '';
    }
    
    // Status bar
    function updateStatusBar() {
      document.getElementById('objectCount').textContent = objects.length;
      document.getElementById('selectedInfo').textContent = selectedObject 
        ? `${selectedObject.userData.name}${selectedObject.userData.locked ? ' (üîí)' : ''}`
        : 'Nenhum selecionado';
    }
    
    // Help
    function toggleHelp() {
      const panel = document.getElementById('helpPanel');
      panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }
    
    // Toast
    function showToast(msg) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.style.display = 'block';
      setTimeout(() => toast.style.display = 'none', 1500);
    }
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
      
      if (e.key === 'Delete') deleteSelected();
      if (e.ctrlKey && e.key === 'd') { e.preventDefault(); duplicateSelected(); }
      if (e.ctrlKey && e.key === 'z') { e.preventDefault(); undo(); }
      if (e.ctrlKey && e.key === 'y') { e.preventDefault(); redo(); }
      if (e.key === 'g') { document.getElementById('gridEnabled').checked = !document.getElementById('gridEnabled').checked; updateGrid(); }
      if (e.key === 'l') { if (selectedObject) { selectedObject.userData.locked ? unlockSelected() : lockSelected(); } }
      if (e.key === 'c') alignToCenter();
      if (e.key === 'm') setMode(currentMode === 'select' ? 'move' : 'select');
      if (e.key === 'h') toggleHelp();
      if (e.key === '1') { showTab('objects'); document.querySelector('.tab-btns button:nth-child(1)').click(); }
      if (e.key === '2') { showTab('transform'); document.querySelector('.tab-btns button:nth-child(2)').click(); }
      if (e.key === '3') { showTab('material'); document.querySelector('.tab-btns button:nth-child(3)').click(); }
      if (e.key === '4') { showTab('scene'); document.querySelector('.tab-btns button:nth-child(4)').click(); }
    });
    
    // Init
    document.getElementById('scene').addEventListener('loaded', () => {
      createGrid();
      createStars();
      addObject('sphere');
      saveState();
      updateStatusBar();
    });
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- CSP liberando todos dom√≠nios oficiais Superflix -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' https://cdn.tailwindcss.com 'unsafe-inline';
        frame-src https://superflixapi.bond https://superflixapi.blog https://superflixapi.site https://superflixapi.live https://superflixapi.run;
        img-src data: blob: https:;
        style-src 'unsafe-inline';
        connect-src https://api.themoviedb.org https://image.tmdb.org;
    ">
    <title>Estou Pobre Sem Netflix...</title>
    <link rel="icon" type="image/png" href="https://www.emojimax.com/uploads/mixes/ai/mixe378cff6bbce0e31b1a6633f05476fd0.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; }
        input, textarea { user-select: text; -webkit-user-select: text; }

        .player-wrapper { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; background: #000; border-radius: 0.5rem; }
        .player-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }

        .season-btn.active { background: #dc2626; border-color: #dc2626; }
        .episode-card.active { border-color: #dc2626; box-shadow: 0 0 10px rgba(220, 38, 38, 0.5); }
        .episode-card:hover { transform: scale(1.05); }

        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255, 255, 255, 0.1); border-left-color: #dc2626; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .toast { position: fixed; bottom: 20px; right: 20px; padding: 12px 24px; border-radius: 8px; color: white; font-weight: 500; z-index: 1000; animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s; opacity: 0; animation-fill-mode: forwards; }
        .toast.success { background: #16a34a; }
        .toast.error { background: #dc2626; }
        .toast.info { background: #2563eb; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { to { opacity: 0; } }

        .fav-btn { transition: all 0.2s ease; }
        .fav-btn:hover { transform: scale(1.2); }
        .fav-btn.active { color: #f59e0b; }

        .tab-btn.active { background: #dc2626; color: white; }
        .filter-btn.active { background: #dc2626; color: white; }
        .watchlist-btn.active { color: #3b82f6; }

        .rating-badge { background: linear-gradient(135deg, #f59e0b, #d97706); padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .stats-card { background: linear-gradient(135deg, #1f2937, #374151); border: 1px solid #4b5563; }

        @media (max-width: 640px) {
            .series-layout { flex-direction: column; }
            .seasons-sidebar { width: 100% !important; border-right: none !important; border-bottom: 1px solid #374151; flex-direction: row !important; overflow-x: auto; padding: 8px !important; }
            .seasons-sidebar div { flex-direction: row !important; gap: 8px !important; }
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-5xl">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-red-500 mb-2">Estou Pobre<span class="text-white"> Sem Netflix</span></h1>
            <p class="text-gray-400 text-sm">Porque pagar overrated</p>
        </header>

        <div class="flex gap-2 mb-6">
            <input type="text" id="searchInput" placeholder="Nome do filme ou s√©rie..." 
                   class="flex-1 bg-gray-800 text-white p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" 
                   onkeypress="handleEnter(event)">
            <button onclick="searchMedia()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-bold transition-colors flex items-center gap-2">
                <span id="searchBtnText">Buscar</span>
                <div id="searchSpinner" class="spinner hidden" style="width: 20px; height: 20px; border-width: 2px;"></div>
            </button>
        </div>

        <div class="flex gap-2 mb-4 flex-wrap">
            <button onclick="showTab('trendingday')" id="tabTrendingday" class="tab-btn px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 transition active">Hoje</button>
            <button onclick="showTab('trendingweek')" id="tabTrendingweek" class="tab-btn px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 transition">Semana</button>
            <button onclick="showTab('search')" id="tabSearch" class="tab-btn px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 transition">Busca</button>
            <button onclick="showTab('history')" id="tabHistory" class="tab-btn px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 transition">Hist√≥rico</button>
            <button onclick="showTab('favorites')" id="tabFavorites" class="tab-btn px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 transition">Favoritos</button>
            <button onclick="showTab('watchlist')" id="tabWatchlist" class="tab-btn px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 transition">Watchlist</button>
            <button onclick="showTab('stats')" id="tabStats" class="tab-btn px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 transition">Stats</button>
        </div>

        <div id="searchFilters" class="hidden flex gap-2 mb-4 flex-wrap items-center bg-gray-800 p-3 rounded-lg">
            <span class="text-gray-400 text-sm">Filtros</span>
            <button onclick="setTypeFilter('all')" id="filterAll" class="filter-btn px-3 py-1 rounded text-sm bg-gray-700 hover:bg-gray-600 transition active">Todos</button>
            <button onclick="setTypeFilter('movie')" id="filterMovie" class="filter-btn px-3 py-1 rounded text-sm bg-gray-700 hover:bg-gray-600 transition">Filmes</button>
            <button onclick="setTypeFilter('tv')" id="filterTv" class="filter-btn px-3 py-1 rounded text-sm bg-gray-700 hover:bg-gray-600 transition">S√©ries</button>
            <span class="text-gray-600">|</span>
            <select id="yearFilter" onchange="applySearchFilters()" class="bg-gray-700 text-white px-3 py-1 rounded text-sm">
                <option value="">Ano</option>
            </select>
        </div>

        <div id="playerSection" class="hidden mb-10">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 id="playerTitle" class="text-2xl font-bold"></h2>
                    <p id="playerSubtitle" class="text-gray-400 text-sm mt-1"></p>
                </div>
                <div>
                    <button onclick="toggleFavorite()" id="favButton" class="fav-btn text-3xl text-gray-500" title="Favorito">‚≠ê</button>
                    <button onclick="toggleWatchlist()" id="watchlistButton" class="watchlist-btn text-3xl text-gray-500 ml-2" title="Watchlist">üìã</button>
                </div>
            </div>
            
            <div class="player-wrapper shadow-2xl shadow-red-900/20 mb-6">
                <iframe id="videoFrame" src="" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen onload="handleIframeLoad()" onerror="handleIframeError()"></iframe>
                <div id="playerLoading" class="absolute inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden">
                    <div class="text-center">
                        <div class="spinner mb-4"></div>
                        <p class="text-gray-300">Carregando player...</p>
                    </div>
                </div>
                <div id="playerError" class="absolute inset-0 bg-black bg-opacity-90 flex items-center justify-center hidden">
                    <div class="text-center p-6">
                        <p class="text-red-500 text-xl mb-4">‚ùå Erro ao carregar player</p>
                        <p class="text-gray-400 mb-4">O conte√∫do pode n√£o estar dispon√≠vel ou todos os servidores falharam.</p>
                        <button onclick="retryPlayer()" class="bg-red-600 hover:bg-red-700 px-6 py-2 rounded">üîÑ Tentar Novamente</button>
                    </div>
                </div>
            </div>
            
            <div id="seriesControls" class="hidden bg-gray-800 rounded-lg overflow-hidden border border-gray-700">
                <div class="flex series-layout">
                    <div class="w-32 seasons-sidebar bg-gray-850 border-r border-gray-700 p-3 flex flex-col">
                        <h3 class="text-xs text-gray-400 uppercase mb-3 font-bold">Temporadas</h3>
                        <div id="seasonsList" class="flex flex-col gap-2"></div>
                    </div>
                    <div class="flex-1 p-4">
                        <h3 class="text-xs text-gray-400 uppercase mb-3 font-bold">Epis√≥dios</h3>
                        <div id="episodesGrid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-3"></div>
                    </div>
                </div>
                <div id="navBar" class="flex items-center justify-between bg-gray-900 px-4 py-3 border-t border-gray-700">
                    <button onclick="prevEpisode()" class="flex items-center gap-2 text-sm text-gray-400 hover:text-white transition">
                        <span>‚¨ÖÔ∏è</span> Anterior
                    </button>
                    <span id="currentEpInfo" class="text-sm font-semibold text-red-400">Ep 1</span>
                    <button onclick="nextEpisode()" class="flex items-center gap-2 text-sm text-gray-400 hover:text-white transition">
                        Pr√≥ximo <span>‚û°Ô∏è</span>
                    </button>
                </div>
            </div>
        </div>

        <div id="statsSection" class="hidden mb-10">
            <h2 class="text-2xl font-bold mb-6">üìä Suas Estat√≠sticas</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="stats-card p-4 rounded-lg text-center">
                    <div class="text-3xl font-bold text-red-500" id="statWatched">0</div>
                    <div class="text-gray-400 text-sm">Assistidos</div>
                </div>
                <div class="stats-card p-4 rounded-lg text-center">
                    <div class="text-3xl font-bold text-yellow-500" id="statFavorites">0</div>
                    <div class="text-gray-400 text-sm">Favoritos</div>
                </div>
                <div class="stats-card p-4 rounded-lg text-center">
                    <div class="text-3xl font-bold text-blue-500" id="statWatchlist">0</div>
                    <div class="text-gray-400 text-sm">Watchlist</div>
                </div>
                <div class="stats-card p-4 rounded-lg text-center">
                    <div class="text-3xl font-bold text-green-500" id="statHours">0h</div>
                    <div class="text-gray-400 text-sm">Tempo estimado</div>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="stats-card p-4 rounded-lg">
                    <h3 class="font-bold mb-3">üé¨ Filmes vs S√©ries</h3>
                    <div class="flex gap-2 h-6 rounded overflow-hidden">
                        <div class="bg-red-600" id="statMoviesBar" style="width: 50%"></div>
                        <div class="bg-blue-600" id="statSeriesBar" style="width: 50%"></div>
                    </div>
                    <div class="flex justify-between text-sm text-gray-400 mt-2">
                        <span id="statMoviesCount">0 filmes</span>
                        <span id="statSeriesCount">0 s√©ries</span>
                    </div>
                </div>
                <div class="stats-card p-4 rounded-lg">
                    <h3 class="font-bold mb-3">‚è±Ô∏è √öltimos Assistidos</h3>
                    <div id="recentWatched" class="text-gray-400 text-sm">Assista algo para ver aqui!</div>
                </div>
            </div>
        </div>

        <div id="resultsGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
    </div>

    <script>
        // ========================================
        // SUPERFLIX DOMAINS + FALLBACK
        // ========================================
        const SUPERFLIX_DOMAINS = [
            "https://superflixapi.bond",
            "https://superflixapi.blog",
            "https://superflixapi.site",
            "https://superflixapi.live",
            "https://superflixapi.run"
        ];

        let currentDomainIndex = 0;
        // Caminho + hash, sem dom√≠nio, ex: /filme/tt0068646#noLink
        let currentPlayerPath = "";

        function getCurrentDomain() {
            return SUPERFLIX_DOMAINS[currentDomainIndex];
        }

        function getFullPlayerUrl() {
            return getCurrentDomain() + currentPlayerPath;
        }

        function tryNextDomain() {
            if (currentDomainIndex < SUPERFLIX_DOMAINS.length - 1) {
                currentDomainIndex++;
                showToast(`Tentando servidor ${currentDomainIndex + 1}/${SUPERFLIX_DOMAINS.length}...`, "info");
                return true;
            }
            showToast('Todos servidores Superflix falharam', 'error');
            return false;
        }

        function resetDomain() {
            currentDomainIndex = 0;
        }

        // ========================================
        // ESTADO GLOBAL
        // ========================================
        let currentMediaId = null;
        let currentMediaType = null;
        let currentMediaTitle = null;
        let currentMediaPoster = null;
        let currentSeason = 1;
        let currentEpisode = 1;
        let episodesData = [];
        let totalSeasons = 1;
        let currentTab = 'trendingday';
        const TMDB_API_KEY = 'bbd242a4dedabc93d26b08b7af509d57';

        let trendingCache = { day: [], week: [] };
        let trendingPage = { day: 1, week: 1 };
        let trendingMaxPage = { day: 10, week: 10 };
        let isLoadingMore = false;
        let searchResults = [];
        let currentTypeFilter = 'all';
        let currentYearFilter = '';

        // ========================================
        // UTILS
        // ========================================
        function initYearFilter() {
            const select = document.getElementById('yearFilter');
            const currentYear = new Date().getFullYear();
            for (let year = currentYear; year >= 1950; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                select.appendChild(option);
            }
        }

        function showToast(message, type = 'info') {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function getStorage(key) {
            try {
                return JSON.parse(localStorage.getItem(key)) || [];
            } catch {
                return [];
            }
        }

        function setStorage(key, value) {
            localStorage.setItem(key, JSON.stringify(value));
        }

        // ========================================
        // HIST√ìRICO / FAVORITOS / WATCHLIST
        // ========================================
        function addToHistory(item) {
            let history = getStorage('watchhistory');
            history = history.filter(h => !(h.id === item.id && h.type === item.type));
            history.unshift({ ...item, watchedAt: new Date().toISOString() });
            history = history.slice(0, 50);
            setStorage('watchhistory', history);
        }

        function getFavorites() {
            return getStorage('favorites');
        }

        function isFavorite(id, type) {
            const favorites = getFavorites();
            return favorites.some(f => f.id == id && f.type === type);
        }

        function toggleFavorite() {
            if (!currentMediaId) return;
            let favorites = getFavorites();
            const exists = favorites.findIndex(f => f.id == currentMediaId && f.type === currentMediaType);

            if (exists >= 0) {
                favorites.splice(exists, 1);
                showToast('Removido dos favoritos', 'info');
                document.getElementById('favButton').classList.remove('active');
                document.getElementById('favButton').textContent = '‚≠ê';
            } else {
                favorites.push({
                    id: currentMediaId,
                    type: currentMediaType,
                    title: currentMediaTitle,
                    poster: currentMediaPoster,
                    addedAt: new Date().toISOString()
                });
                showToast('Adicionado aos favoritos!', 'success');
                document.getElementById('favButton').classList.add('active');
                document.getElementById('favButton').textContent = '‚òÖ';
            }
            setStorage('favorites', favorites);
        }

        function updateFavoriteButton() {
            const btn = document.getElementById('favButton');
            if (isFavorite(currentMediaId, currentMediaType)) {
                btn.classList.add('active');
                btn.textContent = '‚òÖ';
            } else {
                btn.classList.remove('active');
                btn.textContent = '‚≠ê';
            }
        }

        function getWatchlist() {
            return getStorage('watchlist');
        }

        function isInWatchlist(id, type) {
            return getWatchlist().some(w => w.id == id && w.type === type);
        }

        function toggleWatchlist() {
            if (!currentMediaId) return;
            let watchlist = getWatchlist();
            const exists = watchlist.findIndex(w => w.id == currentMediaId && w.type === currentMediaType);

            if (exists >= 0) {
                watchlist.splice(exists, 1);
                showToast('Removido da watchlist', 'info');
                document.getElementById('watchlistButton').classList.remove('active');
            } else {
                watchlist.push({
                    id: currentMediaId,
                    type: currentMediaType,
                    title: currentMediaTitle,
                    poster: currentMediaPoster,
                    addedAt: new Date().toISOString()
                });
                showToast('Adicionado watchlist!', 'success');
                document.getElementById('watchlistButton').classList.add('active');
            }
            setStorage('watchlist', watchlist);
        }

        function updateWatchlistButton() {
            const btn = document.getElementById('watchlistButton');
            if (isInWatchlist(currentMediaId, currentMediaType)) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        }

        function saveProgress() {
            if (!currentMediaId || currentMediaType !== 'tv') return;
            let progress = getStorage('watchprogress');
            const key = `${currentMediaType}-${currentMediaId}`;
            progress[key] = {
                season: currentSeason,
                episode: currentEpisode,
                updatedAt: new Date().toISOString()
            };
            setStorage('watchprogress', progress);
        }

        function getProgress(id, type) {
            try {
                const progress = JSON.parse(localStorage.getItem('watchprogress'));
                return progress[`${type}-${id}`] || null;
            } catch {
                return null;
            }
        }

        // ========================================
        // ABAS / LISTAGENS
        // ========================================
        function showTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            const tabId = `tab${tab.split('-').map(s => s.charAt(0).toUpperCase() + s.slice(1)).join('')}`;
            const tabBtn = document.getElementById(tabId);
            if (tabBtn) tabBtn.classList.add('active');

            document.getElementById('playerSection').classList.add('hidden');
            document.getElementById('videoFrame').src = '';
            document.getElementById('statsSection').classList.add('hidden');
            document.getElementById('resultsGrid').classList.remove('hidden');

            const searchFilters = document.getElementById('searchFilters');
            if (tab === 'search') searchFilters.classList.remove('hidden');
            else searchFilters.classList.add('hidden');

            const grid = document.getElementById('resultsGrid');
            if (tab === 'trendingday')      loadTrending('day');
            else if (tab === 'trendingweek') loadTrending('week');
            else if (tab === 'history')      renderHistory();
            else if (tab === 'favorites')    renderFavorites();
            else if (tab === 'watchlist')    renderWatchlist();
            else if (tab === 'stats') {
                document.getElementById('resultsGrid').classList.add('hidden');
                document.getElementById('statsSection').classList.remove('hidden');
                updateStats();
            } else {
                grid.innerHTML = '<p class="text-center col-span-4 text-gray-500">Fa√ßa uma busca acima</p>';
            }
        }

        async function loadTrending(period, append = false) {
            const grid = document.getElementById('resultsGrid');
            if (!append && trendingCache[period].length > 0) {
                grid.innerHTML = '';
                trendingCache[period].forEach(item => grid.appendChild(createMediaCard(item)));
                return;
            }
            if (append && isLoadingMore) return;
            if (trendingPage[period] > trendingMaxPage[period]) return;

            isLoadingMore = true;
            if (!append) {
                grid.innerHTML = '<div class="col-span-4 flex justify-center py-12"><div class="spinner"></div></div>';
                trendingPage[period] = 1;
                trendingCache[period] = [];
            } else {
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'loadingMore';
                loadingDiv.className = 'col-span-4 flex justify-center py-6';
                loadingDiv.innerHTML = '<div class="spinner"></div>';
                grid.appendChild(loadingDiv);
            }

            try {
                const url = `https://api.themoviedb.org/3/trending/all/${period}?api_key=${TMDB_API_KEY}&language=pt-BR&page=${trendingPage[period]}`;
                const res = await fetch(url);
                const data = await res.json();

                const loadingEl = document.getElementById('loadingMore');
                if (loadingEl) loadingEl.remove();

                if (!data.results || data.results.length === 0) {
                    if (!append) grid.innerHTML = '<p class="text-center col-span-4 text-gray-400">Nenhum conte√∫do em alta.</p>';
                    trendingMaxPage[period] = trendingPage[period];
                    isLoadingMore = false;
                    return;
                }

                const newItems = data.results.filter(i => i.media_type === 'movie' || i.media_type === 'tv');
                trendingCache[period].push(...newItems);

                if (!append) grid.innerHTML = '';
                newItems.forEach(item => grid.appendChild(createMediaCard(item)));

                trendingPage[period]++;
                trendingMaxPage[period] = data.total_pages > 10 ? 10 : data.total_pages;
            } catch (error) {
                const loadingEl = document.getElementById('loadingMore');
                if (loadingEl) loadingEl.remove();
                if (!append) grid.innerHTML = '<p class="text-center col-span-4 text-red-500">Erro ao carregar trending.</p>';
                showToast('Erro ao carregar conte√∫do em alta', 'error');
            } finally {
                isLoadingMore = false;
            }
        }

        function renderHistory() {
            const grid = document.getElementById('resultsGrid');
            const history = getStorage('watchhistory');
            if (history.length === 0) {
                grid.innerHTML = '<p class="text-center col-span-4 text-gray-500">Nenhum item no hist√≥rico</p>';
                return;
            }
            grid.innerHTML = '';
            history.forEach(item => grid.appendChild(createMediaCard(item, true)));
        }

        function renderFavorites() {
            const grid = document.getElementById('resultsGrid');
            const favorites = getFavorites();
            if (favorites.length === 0) {
                grid.innerHTML = '<p class="text-center col-span-4 text-gray-500">Nenhum favorito ainda</p>';
                return;
            }
            grid.innerHTML = '';
            favorites.forEach(item => grid.appendChild(createMediaCard(item, true)));
        }

        function renderWatchlist() {
            const grid = document.getElementById('resultsGrid');
            const watchlist = getWatchlist();
            if (watchlist.length === 0) {
                grid.innerHTML = '<p class="text-center col-span-4 text-gray-500">Watchlist vazia - adicione algo para assistir depois!</p>';
                return;
            }
            grid.innerHTML = '';
            watchlist.forEach(item => grid.appendChild(createMediaCard(item, true)));
        }

        function setTypeFilter(filter) {
            currentTypeFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`filter${filter.charAt(0).toUpperCase() + filter.slice(1)}`).classList.add('active');
            applySearchFilters();
        }

        function applySearchFilters() {
            currentYearFilter = document.getElementById('yearFilter').value;
            if (searchResults.length === 0) return;
            const grid = document.getElementById('resultsGrid');
            let filtered = searchResults;

            if (currentTypeFilter !== 'all') {
                filtered = filtered.filter(i => i.media_type === currentTypeFilter || i.type === currentTypeFilter);
            }
            if (currentYearFilter) {
                filtered = filtered.filter(i => {
                    const date = i.release_date || i.first_air_date;
                    return date && date.startsWith(currentYearFilter);
                });
            }

            grid.innerHTML = '';
            if (filtered.length === 0) {
                grid.innerHTML = '<p class="text-center col-span-4 text-gray-400">Nenhum resultado com esses filtros.</p>';
                return;
            }
            filtered.forEach(item => grid.appendChild(createMediaCard(item)));
            showToast(`${filtered.length} resultados`, 'info');
        }

        function updateStats() {
            const history = getStorage('watchhistory');
            const favorites = getFavorites();
            const watchlist = getWatchlist();
            const movies = history.filter(h => h.type === 'movie').length;
            const series = history.filter(h => h.type === 'tv').length;
            const total = movies + series;

            document.getElementById('statWatched').textContent = history.length;
            document.getElementById('statFavorites').textContent = favorites.length;
            document.getElementById('statWatchlist').textContent = watchlist.length;

            const hours = Math.round((movies * 2 + series * 0.75));
            document.getElementById('statHours').textContent = `${hours}h`;

            document.getElementById('statMoviesCount').textContent = `${movies} filmes`;
            document.getElementById('statSeriesCount').textContent = `${series} s√©ries`;

            if (total > 0) {
                const moviePercent = (movies / total) * 100;
                const seriesPercent = (series / total) * 100;
                document.getElementById('statMoviesBar').style.width = `${moviePercent}%`;
                document.getElementById('statSeriesBar').style.width = `${seriesPercent}%`;
            }

            const recent = history.slice(0, 5);
            if (recent.length > 0) {
                document.getElementById('recentWatched').innerHTML =
                    recent.map(item => `<div class="truncate py-1">${item.title}</div>`).join('');
            } else {
                document.getElementById('recentWatched').innerHTML = 'Assista algo para ver aqui!';
            }
        }

        function createMediaCard(item, fromStorage = false) {
            const title = item.title || item.name;
            const date = (item.release_date || item.first_air_date || item.watchedAt?.split('T')[0]);
            const poster = fromStorage ? item.poster : (
                item.poster_path
                    ? `https://image.tmdb.org/t/p/w300${item.poster_path}`
                    : 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 450"%3E%3Crect fill="%23374151" width="300" height="450"/%3E%3Ctext x="150" y="225" fill="%239ca3af" text-anchor="middle" font-size="20"%3ESem Imagem%3C/text%3E%3C/svg%3E'
            );

            const type = item.media_type || item.type;
            const card = document.createElement('div');
            card.className = 'bg-gray-800 rounded-lg overflow-hidden hover:scale-105 transition-transform cursor-pointer group';
            card.onclick = () => selectMedia(item.id, type, title, poster);

            const progress = getProgress(item.id, type);
            const progressBadge = progress
                ? `<span class="absolute top-2 left-2 bg-red-600 text-xs px-2 py-1 rounded">S${progress.season}E${progress.episode}</span>`
                : '';

            const rating = item.vote_average ? item.vote_average.toFixed(1) : null;
            const ratingBadge = rating && rating > 0
                ? `<span class="absolute top-2 right-2 rating-badge">‚≠ê ${rating}</span>`
                : '';

            card.innerHTML = `
                <div class="relative">
                    <img src="${poster}" class="w-full h-auto object-cover aspect-[2/3]" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' viewBox=\\'0 0 300 450\\'%3E%3Crect fill=\\'%23374151\\' width=\\'300\\' height=\\'450\\'/%3E%3Ctext x=\\'150\\' y=\\'225\\' fill=\\'%239ca3af\\' text-anchor=\\'middle\\' font-size=\\'20\\'%3ESem Imagem%3C/text%3E%3C/svg%3E'">
                    ${progressBadge}
                    ${ratingBadge}
                    <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 flex items-center justify-center transition-all">
                        <span class="text-transparent group-hover:text-white font-bold text-lg">‚ñ∂Ô∏è Assistir</span>
                    </div>
                </div>
                <div class="p-3">
                    <h3 class="font-bold text-sm truncate" title="${title}">${title}</h3>
                    <div class="flex justify-between text-xs text-gray-400 mt-1">
                        <span>${date ? date.split('-')[0] : ''}</span>
                        <span class="uppercase border border-gray-600 px-1 rounded">${type === 'tv' ? 'S√©rie' : 'Filme'}</span>
                    </div>
                </div>
            `;
            return card;
        }

        // ========================================
        // BUSCA (TMDB)
        // ========================================
        async function searchMedia() {
            const query = document.getElementById('searchInput').value;
            const grid = document.getElementById('resultsGrid');
            const spinner = document.getElementById('searchSpinner');
            const btnText = document.getElementById('searchBtnText');

            if (!query) {
                showToast('Digite o nome do filme ou s√©rie.', 'error');
                return;
            }

            spinner.classList.remove('hidden');
            btnText.textContent = '';
            document.getElementById('playerSection').classList.add('hidden');
            document.getElementById('videoFrame').src = '';
            grid.innerHTML = '<div class="col-span-4 flex justify-center py-12"><div class="spinner"></div></div>';
            showTab('search');
            document.getElementById('tabSearch').classList.add('active');

            try {
                const url = `https://api.themoviedb.org/3/search/multi?api_key=${TMDB_API_KEY}&language=pt-BR&query=${encodeURIComponent(query)}`;
                const res = await fetch(url);
                if (!res.ok) throw new Error(`Erro ${res.status}: ${res.statusText}`);

                const data = await res.json();
                grid.innerHTML = '';

                if (!data.results || data.results.length === 0) {
                    grid.innerHTML = '<p class="text-center col-span-4 text-gray-400">Nenhum resultado encontrado.</p>';
                    showToast('Nenhum resultado encontrado', 'info');
                    searchResults = [];
                    return;
                }

                searchResults = data.results.filter(i => i.media_type === 'movie' || i.media_type === 'tv');
                currentTypeFilter = 'all';
                currentYearFilter = '';
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById('filterAll').classList.add('active');
                document.getElementById('yearFilter').value = '';

                searchResults.forEach(item => grid.appendChild(createMediaCard(item)));
                showToast(`${searchResults.length} resultados encontrados`, 'success');
            } catch (error) {
                grid.innerHTML = '<p class="text-center col-span-4 text-red-500">Erro na API. Tente novamente.</p>';
                showToast('Erro ao buscar. Tente novamente.', 'error');
            } finally {
                spinner.classList.add('hidden');
                btnText.textContent = 'Buscar';
            }
        }

        // ========================================
        // PLAYER SUPERFLIX (DOC OFICIAL)
        // ========================================
        async function selectMedia(tmdbId, type, title, poster) {
            currentMediaId = tmdbId;
            currentMediaType = type;
            currentMediaTitle = title;
            currentMediaPoster = poster;
            currentSeason = 1;
            currentEpisode = 1;

            resetDomain();
            addToHistory({ id: tmdbId, type, title, poster });

            document.getElementById('resultsGrid').innerHTML = '';
            document.getElementById('playerSection').classList.remove('hidden');
            document.getElementById('playerTitle').innerText = title;
            updateFavoriteButton();
            updateWatchlistButton();

            const iframe = document.getElementById('videoFrame');
            const seriesControls = document.getElementById('seriesControls');
            document.getElementById('playerSection').scrollIntoView({ behavior: 'smooth' });
            document.getElementById('playerLoading').classList.remove('hidden');
            document.getElementById('playerError').classList.add('hidden');

            if (type === 'movie') {
                seriesControls.classList.add('hidden');
                document.getElementById('playerSubtitle').innerText = 'üé¨ Filme';

                const imdbId = await getImdbId(tmdbId, 'movie'); // retorna ttXXXX
                const finalId = imdbId || `tt${tmdbId}`; // fallback tosco se n√£o vier

                // URL igual doc: https://superflixapi.bond/filme/ttID + hash opcional
                currentPlayerPath = `/filme/${finalId}#noLink#noBackground`;
                iframe.src = getFullPlayerUrl();
                showToast('Carregando filme...', 'info');
            } else if (type === 'tv') {
                seriesControls.classList.remove('hidden');
                const progress = getProgress(tmdbId, type);
                if (progress) {
                    currentSeason = progress.season;
                    currentEpisode = progress.episode;
                    showToast(`Continuando de S${progress.season}E${progress.episode}`, 'info');
                }
                await loadSeriesInfo(tmdbId);
            }
        }

        async function loadSeriesInfo(tmdbId) {
            try {
                const url = `https://api.themoviedb.org/3/tv/${tmdbId}?api_key=${TMDB_API_KEY}&language=pt-BR`;
                const res = await fetch(url);
                const data = await res.json();

                totalSeasons = data.number_of_seasons;
                document.getElementById('playerSubtitle').innerText = `üì∫ S√©rie (${data.number_of_seasons} temp, ${data.number_of_episodes} eps)`;

                const seasonsList = document.getElementById('seasonsList');
                seasonsList.innerHTML = '';
                for (let i = 1; i <= data.number_of_seasons; i++) {
                    const btn = document.createElement('button');
                    btn.className = `season-btn text-sm py-2 px-3 rounded border border-gray-600 hover:border-red-500 transition ${i === currentSeason ? 'active' : ''}`;
                    btn.innerText = `T${i}`;
                    btn.onclick = () => selectSeason(i);
                    seasonsList.appendChild(btn);
                }
                await loadSeasonEpisodes(currentSeason);
            } catch (e) {
                showToast('Erro ao carregar informa√ß√µes da s√©rie', 'error');
            }
        }

        async function selectSeason(seasonNum) {
            currentSeason = seasonNum;
            currentEpisode = 1;
            document.querySelectorAll('.season-btn').forEach((btn, idx) => {
                btn.classList.toggle('active', idx + 1 === seasonNum);
            });
            await loadSeasonEpisodes(seasonNum);
        }

        async function loadSeasonEpisodes(seasonNum) {
            const grid = document.getElementById('episodesGrid');
            grid.innerHTML = '<div class="col-span-full flex justify-center py-4"><div class="spinner"></div></div>';
            try {
                const url = `https://api.themoviedb.org/3/tv/${currentMediaId}/season/${seasonNum}?api_key=${TMDB_API_KEY}&language=pt-BR`;
                const res = await fetch(url);
                const data = await res.json();
                episodesData = data.episodes;

                grid.innerHTML = '';
                episodesData.forEach((ep, idx) => {
                    const thumb = ep.still_path
                        ? `https://image.tmdb.org/t/p/w185${ep.still_path}`
                        : 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 185 104"%3E%3Crect fill="%23374151" width="185" height="104"/%3E%3Ctext x="92" y="52" fill="%239ca3af" text-anchor="middle" font-size="12"%3ESem Img%3C/text%3E%3C/svg%3E';

                    const card = document.createElement('div');
                    card.className = `episode-card bg-gray-700 rounded overflow-hidden cursor-pointer transition-all ${idx + 1 === currentEpisode ? 'active' : ''}`;
                    card.onclick = () => playEpisode(idx + 1);

                    const overlay = idx + 1 === currentEpisode
                        ? '<div class="absolute inset-0 bg-red-600 bg-opacity-30 flex items-center justify-center"><span class="text-white text-lg">‚ñ∂Ô∏è</span></div>'
                        : '';

                    card.innerHTML = `
                        <div class="relative">
                            <img src="${thumb}" class="w-full aspect-video object-cover" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' viewBox=\\'0 0 185 104\\'%3E%3Crect fill=\\'%23374151\\' width=\\'185\\' height=\\'104\\'/%3E%3Ctext x=\\'92\\' y=\\'52\\' fill=\\'%239ca3af\\' text-anchor=\\'middle\\' font-size=\\'12\\'%3ESem Img%3C/text%3E%3C/svg%3E'">
                            ${overlay}
                        </div>
                        <div class="p-2 text-center">
                            <span class="text-xs font-bold">${ep.episode_number}</span>
                        </div>
                    `;
                    grid.appendChild(card);
                });

                playEpisode(currentEpisode);
            } catch (e) {
                grid.innerHTML = '<p class="col-span-full text-red-500 text-sm">Erro ao carregar epis√≥dios</p>';
            }
        }

        function playEpisode(epNum) {
            currentEpisode = epNum;
            const iframe = document.getElementById('videoFrame');

            // URL igual doc: /serie/ID/SEASON/EP#params
            currentPlayerPath = `/serie/${currentMediaId}/${currentSeason}/${epNum}#noEpList#noLink`;
            iframe.src = getFullPlayerUrl();
            saveProgress();

            document.getElementById('playerLoading').classList.remove('hidden');
            document.getElementById('playerError').classList.add('hidden');

            document.querySelectorAll('.episode-card').forEach((card, idx) => {
                card.classList.toggle('active', idx + 1 === epNum);
                const overlay = card.querySelector('.absolute');
                if (idx + 1 === epNum && !overlay) {
                    card.querySelector('.relative').innerHTML += '<div class="absolute inset-0 bg-red-600 bg-opacity-30 flex items-center justify-center"><span class="text-white text-lg">‚ñ∂Ô∏è</span></div>';
                } else if (idx + 1 !== epNum && overlay) {
                    overlay.remove();
                }
            });

            const epData = episodesData[epNum - 1];
            const epName = epData?.name;
            document.getElementById('currentEpInfo').innerText =
                `S${String(currentSeason).padStart(2, '0')}E${String(epNum).padStart(2, '0')}${epName ? ' - ' + epName : ''}`;
        }

        function prevEpisode() {
            if (currentEpisode > 1) {
                playEpisode(currentEpisode - 1);
            } else if (currentSeason > 1) {
                selectSeason(currentSeason - 1);
                setTimeout(() => playEpisode(episodesData.length), 500);
            }
        }

        function nextEpisode() {
            if (currentEpisode < episodesData.length) {
                playEpisode(currentEpisode + 1);
            } else if (currentSeason < totalSeasons) {
                selectSeason(currentSeason + 1);
            }
        }

        async function getImdbId(id, type) {
            try {
                const url = `https://api.themoviedb.org/3/${type}/${id}/external_ids?api_key=${TMDB_API_KEY}`;
                const res = await fetch(url);
                const data = await res.json();
                return data.imdb_id;
            } catch {
                return null;
            }
        }

        // ========================================
        // IFRAME HANDLERS
        // ========================================
        function handleIframeLoad() {
            setTimeout(() => {
                document.getElementById('playerLoading').classList.add('hidden');
                document.getElementById('playerError').classList.add('hidden');
            }, 800);
        }

        function handleIframeError() {
            const loading = document.getElementById('playerLoading');
            const error = document.getElementById('playerError');
            if (loading) loading.classList.add('hidden');

            if (currentPlayerPath && tryNextDomain()) {
                const iframe = document.getElementById('videoFrame');
                iframe.src = getFullPlayerUrl();
                if (error) error.classList.add('hidden');
                return;
            }

            if (error) error.classList.remove('hidden');
            showToast('Erro ao carregar player - todos os servidores falharam', 'error');
        }

        function retryPlayer() {
            resetDomain();
            const iframe = document.getElementById('videoFrame');
            iframe.src = '';
            setTimeout(() => {
                iframe.src = getFullPlayerUrl();
                document.getElementById('playerError').classList.add('hidden');
                document.getElementById('playerLoading').classList.remove('hidden');
            }, 100);
        }

        function handleEnter(e) {
            if (e.key === 'Enter') searchMedia();
        }

        // ========================================
        // SCROLL INFINITO + INIT
        // ========================================
        window.addEventListener('scroll', () => {
            if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 500) {
                if (currentTab === 'trendingday')      loadTrending('day', true);
                else if (currentTab === 'trendingweek') loadTrending('week', true);
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            initYearFilter();
            loadTrending('day');
            console.log('Player carregado com Superflix domains:', SUPERFLIX_DOMAINS.length);
        });
    </script>
</body>
</html>

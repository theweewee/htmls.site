<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor HTML - htmls.site</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'><text y='1.2em' font-size='90'>üöÄ</text></svg>">
    <style>
        :root {
            --bg-main: #101014;
            --bg-panel: #17171c;
            --bg-header: #111117;
            --border: #23232e;
            --accent: #6366f1;
            --accent-hover: #4f46e5;
            --text-main: #e9e9ed;
            --text-muted: #9ca3af;
            --success: #10b981;
            --danger: #ef4444;
        }

        * { box-sizing: border-box; }

        html, body {
            width: 100vw;
            height: 100vh;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Inter', 'Segoe UI', sans-serif;
            background: var(--bg-main);
            color: var(--text-main);
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: var(--bg-header);
            padding: 12px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
        }
        .header h1 {
            font-size: 18px;
            margin: 0;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Layout Principal */
        .main-container {
            flex: 1;
            display: flex;
            height: calc(100vh - 60px);
            overflow: hidden;
        }

        /* Coluna da Esquerda (Editor) */
        .editor-section {
            width: 50%;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border);
            background: var(--bg-panel);
            min-width: 320px;
        }

        /* Painel de Controle (Formul√°rio) */
        .controls-panel {
            padding: 16px;
            background: var(--bg-header);
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
            min-width: 150px;
        }
        
        .input-group label { font-size: 12px; color: var(--text-muted); }
        
        input[type="text"] {
            background: var(--bg-main);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 8px 12px;
            border-radius: 6px;
            outline: none;
            font-size: 14px;
        }
        input[type="text"]:focus { border-color: var(--accent); }

        /* Bot√£o Toggle (Template) */
        .toggle-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #23232e;
            padding: 8px 12px;
            border-radius: 6px;
            height: 52px; /* Alinha com os inputs */
        }
        .toggle-wrapper label { font-size: 12px; cursor: pointer; user-select: none; }
        input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover:not(:disabled) { background: var(--accent-hover); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }
        
        .btn-secondary { background: #2d2d3a; color: var(--text-muted); border: 1px solid var(--border); }
        .btn-secondary:hover { color: var(--text-main); border-color: var(--text-muted); }

        /* Abas */
        .tabs {
            display: flex;
            background: var(--bg-header);
            border-bottom: 1px solid var(--border);
        }
        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-muted);
            border-right: 1px solid var(--border);
            background: transparent;
            transition: all 0.2s;
        }
        .tab.active { background: var(--bg-panel); color: var(--accent); border-bottom: 2px solid var(--accent); }
        .tab:hover:not(.active) { color: var(--text-main); background: #1c1c24; }

        /* √Åreas de Texto */
        .editor-container {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        .code-area {
            width: 100%;
            height: 100%;
            background: var(--bg-panel);
            color: #e9e9ed;
            border: none;
            padding: 16px;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: none;
            outline: none;
            display: none;
        }
        .code-area.active { display: block; }

        /* Lista de Arquivos */
        .file-manager {
            height: 180px;
            border-top: 1px solid var(--border);
            background: #0d0d11;
            display: flex;
            flex-direction: column;
        }
        .fm-header {
            padding: 8px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #141419;
            border-bottom: 1px solid var(--border);
        }
        .fm-header span { font-size: 12px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); }
        .file-list {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            margin: 0;
            list-style: none;
        }
        .file-item {
            padding: 8px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #1f1f28;
            transition: background 0.1s;
        }
        .file-item:hover { background: #1c1c24; }
        .file-name { font-size: 13px; color: var(--accent); cursor: pointer; text-decoration: none; }
        .file-name:hover { text-decoration: underline; }
        
        .actions { display: flex; gap: 8px; }
        .btn-mini {
            padding: 4px 8px;
            font-size: 11px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
        }
        .btn-edit { background: #2d2d3a; color: white; }
        .btn-del { background: #3a1d1d; color: #fca5a5; }
        .btn-del:hover { background: var(--danger); color: white; }

        /* Preview */
        .preview-section {
            width: 50%;
            background: #fff;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
        }

        /* Status Bar */
        .status-bar {
            position: absolute;
            bottom: 16px;
            right: 16px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            pointer-events: none;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .status-bar.show { opacity: 1; transform: translateY(0); }
        .status-info { background: #3b82f6; color: white; }
        .status-success { background: var(--success); color: white; }
        .status-error { background: var(--danger); color: white; }

        @media (max-width: 800px) {
            .main-container { flex-direction: column; overflow-y: auto; }
            .editor-section, .preview-section { width: 100%; height: 500px; }
        }
    </style>
</head>
<body>

    <div class="header">
        <h1>üöÄ Editor - htmls.site</h1>
        <div id="status-display" class="status-bar">Pronto</div>
    </div>

    <div class="main-container">
        <div class="editor-section">
            
            <div class="controls-panel">
                <div class="input-group">
                    <label for="filename">Nome</label>
                    <input type="text" id="filename" value="index.html" placeholder="ex: pagina.html">
                </div>
                
                <!-- BOT√ÉO QUE VOC√ä PEDIU -->
                <div class="toggle-wrapper" title="Se marcado: adiciona HTML/HEAD/BODY automaticamente. Se desmarcado: Salva EXATAMENTE o que est√° escrito.">
                    <input type="checkbox" id="useTemplate" checked>
                    <label for="useTemplate">Auto-Template</label>
                </div>

                <button id="publishBtn" class="btn btn-primary" disabled>üöÄ Publicar</button>
                <button id="newBtn" class="btn btn-secondary">‚ú® Novo</button>
            </div>

            <div class="tabs">
                <div class="tab active" data-target="html-code">HTML / Conte√∫do</div>
                <div class="tab" data-target="css-code">CSS</div>
                <div class="tab" data-target="js-code">JS</div>
            </div>

            <div class="editor-container">
                <textarea id="html-code" class="code-area active" placeholder="Digite seu c√≥digo..."></textarea>
                <textarea id="css-code" class="code-area" placeholder="CSS (S√≥ funciona com Auto-Template marcado)"></textarea>
                <textarea id="js-code" class="code-area" placeholder="JS (S√≥ funciona com Auto-Template marcado)"></textarea>
            </div>

            <div class="file-manager">
                <div class="fm-header">
                    <span>Arquivos em /htmls/</span>
                    <button id="refreshBtn" class="btn-mini btn-secondary">‚Üª</button>
                </div>
                <ul id="fileList" class="file-list">
                    <li style="padding:16px; color:#666; text-align:center">Conectando...</li>
                </ul>
            </div>
        </div>

        <div class="preview-section">
            <iframe id="preview"></iframe>
        </div>
    </div>

    <script>
        'use strict';

        const CONFIG = {
            repo: { 
                owner: 'theweewee',
                name: 'htmls.site',
                folder: 'htmls',
                branch: 'main' 
            },
            preview: { baseUrl: 'https://htmls.site' },
            jsonbin: { 
                binId: '691e49b043b1c97be9b81a9d', 
                accessKey: '$2a$10$f9KK7vSowGnJI5elo/dAPurqjZAJ3bJaWnsinl/caDfgIcNt28kNi' 
            },
            cache: { tokenKey: 'gh_token_v3', filesKey: 'gh_files_v3', duration: 1000 * 60 * 15 }
        };

        const htmlArea = document.getElementById('html-code');
        const cssArea = document.getElementById('css-code');
        const jsArea = document.getElementById('js-code');
        const previewFrame = document.getElementById('preview');
        const filenameInput = document.getElementById('filename');
        const useTemplateCheckbox = document.getElementById('useTemplate');

        // --- FUN√á√ÉO DE PREVIEW INTELIGENTE ---
        function updatePreview() {
            let content;
            
            if (useTemplateCheckbox.checked) {
                // MODO AUTOM√ÅTICO: Cria estrutura e junta CSS/JS
                const css = `<style>${cssArea.value}</style>`;
                const js = `<script>${jsArea.value}<` + `/script>`;
                
                content = `
                <!DOCTYPE html>
                <html lang="pt-BR">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    ${css}
                </head>
                <body>
                    ${htmlArea.value}
                    ${js}
                </body>
                </html>`;
            } else {
                // MODO MANUAL (RAW): Usa exatamente o que est√° escrito
                content = htmlArea.value;
            }
            
            previewFrame.srcdoc = content;
        }

        // --- FUN√á√ÉO PARA GERAR O CONTE√öDO DO ARQUIVO ---
        function buildFinalContent() {
            // Se o bot√£o estiver desmarcado, retorna S√ì o texto do HTML Area
            if (!useTemplateCheckbox.checked) {
                return htmlArea.value;
            }

            // Se marcado, constr√≥i o template
            return `<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${filenameInput.value}</title>
    <style>
${cssArea.value}
    </style>
</head>
<body>
${htmlArea.value}
    <script>
${jsArea.value}
    <` + `/script>
</body>
</html>`;
        }

        // Event Listeners
        [htmlArea, cssArea, jsArea].forEach(el => el.addEventListener('input', updatePreview));
        useTemplateCheckbox.addEventListener('change', updatePreview);

        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.code-area').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.target).classList.add('active');
            });
        });

        // --- PARTE DO GITHUB ---
        class NotificationSystem {
            constructor() {
                this.el = document.getElementById('status-display');
                this.timer = null;
            }
            show(msg, type = 'info') {
                clearTimeout(this.timer);
                this.el.textContent = msg;
                this.el.className = `status-bar show status-${type}`;
                this.timer = setTimeout(() => this.el.classList.remove('show'), 4000);
            }
        }
        const notify = new NotificationSystem();

        class GitHubService {
            constructor() { this.token = null; }

            async init() {
                const cached = localStorage.getItem(CONFIG.cache.tokenKey);
                if (cached) {
                    const { token, time } = JSON.parse(cached);
                    if (Date.now() - time < CONFIG.cache.duration) {
                        this.token = token;
                        return;
                    }
                }
                try {
                    const res = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.jsonbin.binId}/latest`, {
                        headers: { 'X-Access-Key': CONFIG.jsonbin.accessKey, 'X-Bin-Meta': 'false' }
                    });
                    if (!res.ok) throw new Error('Falha ao autenticar');
                    const data = await res.json();
                    this.token = data.github_token;
                    localStorage.setItem(CONFIG.cache.tokenKey, JSON.stringify({ token: this.token, time: Date.now() }));
                } catch (e) {
                    console.error(e);
                    notify.show('Erro de Autentica√ß√£o', 'error');
                }
            }

            get headers() {
                return {
                    'Authorization': `Bearer ${this.token}`,
                    'Accept': 'application/vnd.github+json',
                    'Content-Type': 'application/json'
                };
            }

            async listFiles() {
                if (!this.token) await this.init();
                const url = `https://api.github.com/repos/${CONFIG.repo.owner}/${CONFIG.repo.name}/contents/${CONFIG.repo.folder}?ref=${CONFIG.repo.branch}`;
                const res = await fetch(url, { headers: this.headers });
                if (!res.ok) return [];
                const files = await res.json();
                return files.filter(f => f.name.endsWith('.html')).sort((a, b) => a.name.localeCompare(b.name));
            }

            async getFile(filename) {
                const url = `https://api.github.com/repos/${CONFIG.repo.owner}/${CONFIG.repo.name}/contents/${CONFIG.repo.folder}/${filename}`;
                const res = await fetch(url, { headers: this.headers });
                if (!res.ok) throw new Error('Arquivo n√£o encontrado');
                const data = await res.json();
                const content = decodeURIComponent(escape(atob(data.content.replace(/\s/g, ''))));
                return { content, sha: data.sha };
            }

            async saveFile(filename, content) {
                const path = `${CONFIG.repo.folder}/${filename}`;
                const url = `https://api.github.com/repos/${CONFIG.repo.owner}/${CONFIG.repo.name}/contents/${path}`;
                let sha = null;
                try {
                    const existing = await this.getFile(filename);
                    sha = existing.sha;
                } catch (e) {}

                const body = {
                    message: `Update ${filename} via Editor`,
                    content: btoa(unescape(encodeURIComponent(content))),
                    branch: CONFIG.repo.branch
                };
                if (sha) body.sha = sha;

                const res = await fetch(url, {
                    method: 'PUT',
                    headers: this.headers,
                    body: JSON.stringify(body)
                });
                if (!res.ok) throw new Error('Erro ao salvar');
                return await res.json();
            }

            async deleteFile(filename) {
                const file = await this.getFile(filename);
                const url = `https://api.github.com/repos/${CONFIG.repo.owner}/${CONFIG.repo.name}/contents/${CONFIG.repo.folder}/${filename}`;
                const res = await fetch(url, {
                    method: 'DELETE',
                    headers: this.headers,
                    body: JSON.stringify({
                        message: `Delete ${filename}`,
                        sha: file.sha,
                        branch: CONFIG.repo.branch
                    })
                });
                if (!res.ok) throw new Error('Erro ao deletar');
            }
        }

        const ghService = new GitHubService();

        // --- CARREGAMENTO DE ARQUIVOS ---
        function parseLoadedContent(fullHtml) {
            // DETECTA SE √â UM ARQUIVO COMPLETO
            if (fullHtml.trim().toLowerCase().startsWith('<!doctype') || fullHtml.includes('<html')) {
                // Se for completo, DESMARCA o autom√°tico e joga tudo no HTML
                useTemplateCheckbox.checked = false;
                htmlArea.value = fullHtml;
                cssArea.value = '';
                jsArea.value = '';
            } else {
                // Se for parcial, MARCA o autom√°tico e tenta separar
                useTemplateCheckbox.checked = true;
                
                const parser = new DOMParser();
                const doc = parser.parseFromString(fullHtml, 'text/html');
                
                const styleTag = doc.querySelector('head style');
                if (styleTag) {
                    cssArea.value = styleTag.innerHTML.trim();
                    styleTag.remove();
                } else cssArea.value = '';

                const scripts = doc.querySelectorAll('body script');
                let jsFound = false;
                scripts.forEach(script => {
                    if (script.innerHTML.trim()) {
                        jsArea.value = script.innerHTML.trim();
                        script.remove();
                        jsFound = true;
                    }
                });
                if (!jsFound) jsArea.value = '';

                htmlArea.value = doc.body.innerHTML.trim().replace(/^\s+|\s+$/g, '');
            }
            
            updatePreview();
        }

        async function loadFileList() {
            const listEl = document.getElementById('fileList');
            listEl.innerHTML = '<li style="padding:16px; color:#666">Carregando...</li>';
            try {
                const files = await ghService.listFiles();
                listEl.innerHTML = '';
                if (files.length === 0) {
                    listEl.innerHTML = '<li style="padding:16px">Nenhum arquivo.</li>';
                    return;
                }
                files.forEach(file => {
                    const li = document.createElement('li');
                    li.className = 'file-item';
                    li.innerHTML = `
                        <div>
                            <div class="file-name" onclick="loadFile('${file.name}')">${file.name}</div>
                            <small style="color:#555">${CONFIG.preview.baseUrl}/${CONFIG.repo.folder}/${file.name}</small>
                        </div>
                        <div class="actions">
                            <button onclick="loadFile('${file.name}')" class="btn-mini btn-edit">‚úèÔ∏è</button>
                            <button onclick="deleteFile('${file.name}')" class="btn-mini btn-del">üóëÔ∏è</button>
                        </div>`;
                    listEl.appendChild(li);
                });
            } catch (e) {
                listEl.innerHTML = '<li style="padding:16px; color:red">Erro ao listar arquivos.</li>';
            }
        }

        window.loadFile = async (filename) => {
            notify.show(`Carregando ${filename}...`, 'info');
            try {
                const data = await ghService.getFile(filename);
                filenameInput.value = filename;
                parseLoadedContent(data.content);
                notify.show('Arquivo carregado!', 'success');
            } catch (e) {
                notify.show(e.message, 'error');
            }
        };

        window.deleteFile = async (filename) => {
            if(!confirm(`Apagar ${filename} permanentemente?`)) return;
            notify.show(`Apagando ${filename}...`, 'info');
            try {
                await ghService.deleteFile(filename);
                await loadFileList();
                notify.show('Arquivo removido.', 'success');
            } catch (e) {
                notify.show(e.message, 'error');
            }
        };

        const publishBtn = document.getElementById('publishBtn');
        publishBtn.addEventListener('click', async () => {
            const filename = filenameInput.value.trim();
            if (!filename.endsWith('.html')) {
                notify.show('O arquivo deve terminar em .html', 'error');
                return;
            }
            publishBtn.disabled = true;
            publishBtn.textContent = '‚è≥ Salvando...';
            try {
                const fullContent = buildFinalContent(); // USA A NOVA FUN√á√ÉO
                await ghService.saveFile(filename, fullContent);
                notify.show('Publicado com sucesso!', 'success');
                await loadFileList();
            } catch (e) {
                notify.show(`Erro: ${e.message}`, 'error');
            } finally {
                publishBtn.disabled = false;
                publishBtn.textContent = 'üöÄ Publicar';
            }
        });

        document.getElementById('refreshBtn').addEventListener('click', loadFileList);
        
        document.getElementById('newBtn').addEventListener('click', () => {
            filenameInput.value = 'novo-arquivo.html';
            // Reseta para o padr√£o autom√°tico
            useTemplateCheckbox.checked = true;
            htmlArea.value = '<h1>Nova P√°gina</h1>';
            cssArea.value = 'body { font-family: sans-serif; }';
            jsArea.value = '';
            updatePreview();
            notify.show('Novo projeto iniciado', 'info');
        });

        (async () => {
            await ghService.init();
            if (ghService.token) {
                publishBtn.disabled = false;
                loadFileList();
                notify.show('Conectado ao htmls.site', 'success');
                // Inicializa o editor com um texto padr√£o
                htmlArea.value = '<h1>Bem vindo</h1>';
                updatePreview();
            }
        })();

    </script>
</body>
</html>
